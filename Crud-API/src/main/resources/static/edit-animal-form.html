<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Animal - Nature Valley Farm</title>
    <link rel="stylesheet" href="./Animal-Form.css">
</head>
<body>
    <nav class="navigation">
        <a href="index.html">Home</a>
        <a href="details.html">Details</a>
        <a href="about.html">About Us</a>
        <a href="new-animal-form.html">New Animal Form</a>
    </nav>

    <h1>Edit Animal</h1>
    
    <div id="loadingMessage">
        <p>Loading animal data...</p>
    </div>

    <form class="animal-form" id="editAnimalForm" style="display: none; flex-direction: column; align-items: center;">
        <input type="hidden" id="animalId">
        
        <label for="name">Name</label>
        <input type="text" id="name" placeholder="Enter animal name" required>

        <label for="breed">Animal Breed</label>
        <input type="text" id="breed" placeholder="Enter animal breed" required>

        <label for="weight">Weight (kg)</label>
        <input type="number" id="weight" placeholder="Enter weight in kg" step="0.1" min="0" required>

        <label for="description">Description</label>
        <textarea id="description" placeholder="Describe the animal" rows="4" required></textarea>

        <div class="button-container">
            <button type="submit" class="update-btn">Update Animal</button>
            <button type="button" id="cancelButton" class="cancel-btn">Cancel</button>
            <button type="button" id="deleteButton" class="delete-btn">Delete Animal</button>
        </div>
    </form>

    <div id="formMessage"></div>

    <!-- Include the API JavaScript file -->
    <script src="./animals-api.js"></script>
    <script>
        // Get animal ID from URL parameter
        const animalId = getUrlParameter('id');
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!animalId) {
                document.getElementById('loadingMessage').innerHTML = 
                    '<p style="color: red;">No animal ID provided. <a href="details.html">Go back to details page</a></p>';
                return;
            }
            
            loadAnimalData();
            setupEventListeners();
        });

        async function loadAnimalData() {
            try {
                const animal = await getAnimalById(animalId);
                
                // Populate form fields
                document.getElementById('animalId').value = animal.animalId;
                document.getElementById('name').value = animal.name;
                document.getElementById('breed').value = animal.breed;
                document.getElementById('weight').value = animal.weight;
                document.getElementById('description').value = animal.description || '';
                
                // Show form and hide loading
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('editAnimalForm').style.display = 'flex';
                document.getElementById('editAnimalForm').style.flexDirection = 'column';
                document.getElementById('editAnimalForm').style.alignItems = 'center';
                
                // Update page title
                document.querySelector('h1').textContent = `Edit ${animal.name}`;
                
            } catch (error) {
                console.error('Error loading animal:', error);
                document.getElementById('loadingMessage').innerHTML = 
                    `<p style="color: red;">Error loading animal: ${error.message}</p>
                     <a href="details.html">Go back to details page</a>`;
            }
        }

        function setupEventListeners() {
            // Form submission for updating
            document.getElementById('editAnimalForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formMessage = document.getElementById('formMessage');
                const submitButton = e.target.querySelector('button[type="submit"]');
                
                // Get form data
                const animalData = {
                    animalId: parseInt(document.getElementById('animalId').value),
                    name: document.getElementById('name').value.trim(),
                    breed: document.getElementById('breed').value.trim(),
                    weight: parseFloat(document.getElementById('weight').value),
                    description: document.getElementById('description').value.trim()
                };
                
                // Validate required fields
                if (!animalData.name || !animalData.breed || !animalData.weight || !animalData.description) {
                    formMessage.innerHTML = '<p style="color: red;">Please fill in all fields.</p>';
                    return;
                }
                
                if (animalData.weight <= 0) {
                    formMessage.innerHTML = '<p style="color: red;">Weight must be greater than 0.</p>';
                    return;
                }
                
                try {
                    // Disable submit button and show loading
                    submitButton.disabled = true;
                    submitButton.textContent = 'Updating Animal...';
                    formMessage.innerHTML = '<p style="color: blue;">Updating animal...</p>';
                    
                    // Submit to API
                    const updatedAnimal = await updateAnimal(animalId, animalData);
                    
                    // Success message
                    formMessage.innerHTML = `
                        <p style="color: green;">
                            <strong>Animal "${updatedAnimal.name}" updated successfully!</strong>
                        </p>
                        <p>
                            <a href="details.html?id=${updatedAnimal.animalId}">View ${updatedAnimal.name}'s details</a> | 
                            <a href="details.html">Back to all animals</a> |
                            <a href="index.html">Go to homepage</a>
                        </p>
                    `;
                    
                } catch (error) {
                    console.error('Error updating animal:', error);
                    formMessage.innerHTML = `<p style="color: red;">Error updating animal: ${error.message}</p>`;
                } finally {
                    // Re-enable submit button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Update Animal';
                }
            });

            // Cancel button
            document.getElementById('cancelButton').addEventListener('click', function() {
                const animalName = document.getElementById('name').value;
                if (confirm(`Cancel editing ${animalName}? Any unsaved changes will be lost.`)) {
                    window.location.href = `details.html?id=${animalId}`;
                }
            });

            // Delete button
            document.getElementById('deleteButton').addEventListener('click', async function() {
                const animalName = document.getElementById('name').value;
                
                if (confirm(`Are you sure you want to delete ${animalName}? This action cannot be undone.`)) {
                    try {
                        document.getElementById('formMessage').innerHTML = '<p style="color: blue;">Deleting animal...</p>';
                        
                        await deleteAnimal(animalId);
                        
                        document.getElementById('formMessage').innerHTML = `
                            <p style="color: green;">
                                <strong>Animal "${animalName}" deleted successfully!</strong>
                            </p>
                            <p>
                                <a href="details.html">View all animals</a> |
                                <a href="index.html">Go to homepage</a>
                            </p>
                        `;
                        
                        // Hide the form after successful deletion
                        document.getElementById('editAnimalForm').style.display = 'none';
                        
                    } catch (error) {
                        console.error('Error deleting animal:', error);
                        document.getElementById('formMessage').innerHTML = 
                            `<p style="color: red;">Error deleting animal: ${error.message}</p>`;
                    }
                }
            });

            // Clear error messages when user starts typing
            document.querySelectorAll('#editAnimalForm input, #editAnimalForm textarea').forEach(input => {
                input.addEventListener('input', function() {
                    const formMessage = document.getElementById('formMessage');
                    if (formMessage.innerHTML.includes('Please fill in all fields') || 
                        formMessage.innerHTML.includes('Weight must be greater than 0')) {
                        formMessage.innerHTML = '';
                    }
                });
            });
        }
    </script>

</body>
</html>